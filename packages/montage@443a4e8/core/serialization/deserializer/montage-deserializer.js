var Montage=require("../../core").Montage,MontageContext=require("./montage-interpreter").MontageContext,MontageReviver=require("./montage-reviver").MontageReviver,Map=require("collections/map").Map,deprecate=require("../../deprecate"),MontageDeserializer=exports.MontageDeserializer=Montage.specialize({_serializationString:{value:null},_serialization:{value:null},serialization:{value:{get:function(){return this._serialization}}},init:{value:function(e,t,i,r){return"string"==typeof e?this._serializationString=e:this._serializationString=JSON.stringify(e),this._require=t,this._locationId=r,this._reviver=(new MontageReviver).init(t,i,this.constructor),this}},deserialize:{value:function(e,t){var i=this._locationId&&MontageDeserializer.moduleContexts.get(this._locationId);if(i)return i._objects.root?Promise.resolve(i._objects):Promise.reject(new Error('Unable to deserialize because a circular dependency was detected. Module "'+this._locationId+'" has already been loaded but its root could not be resolved.'));try{var r=JSON.parse(this._serializationString);return i=(new MontageContext).init(r,this._reviver,e,t,this._require),this._locationId&&MontageDeserializer.moduleContexts.set(this._locationId,i),i.getObjects()}catch(n){return this._formatSerializationSyntaxError(this._serializationString)}}},deserializeObject:{value:function(e){return this.deserialize(e).then(function(e){return e.root})}},preloadModules:{value:function(){var e,t,i,r,n,o,a,s=JSON.parse(this._serializationString),l=this._reviver,u=l.moduleLoader,c=[];if(null!==s)for(t=Object.keys(s),e=0;i=t[e];++e)if(r=s[i],n=r.prototype||r.object){if("string"!=typeof n)throw new Error("Property 'object' of the object with the label '"+i+"' must be a module id");o=MontageReviver.parseObjectLocationId(n),a=u.getModule(o.moduleId,i),Promise.is(a)&&c.push(a)}if(c.length>0)return Promise.all(c)}},getExternalObjectLabels:{value:function(){var e=this._serialization,t=[];for(var i in e)0===Object.keys(e[i]).length&&t.push(i);return t}},_formatSerializationSyntaxError:{value:function(e){var t,i,r,n,o,a="   ",s=this._origin;return require.async("core/jshint").then(function(l){if(l.JSHINT(e))t="Syntax error in the serialization but not able to find it!\n"+e;else{i=l.JSHINT.errors[0],r=e.split("\n"),n=(a+r.length).length,o=i.line-1;for(var u=0,c=r.length;u<c;u++)r[u]=new Array(n-(u+1+"").length+1).join(u===o?">":" ")+(u+1)+" "+r[u];t="Syntax error at line "+i.line+(s?" from "+s:"")+":\n"+i.evidence+"\n"+i.reason+"\n"+r.join("\n")}throw new Error(t)})}},initWithObject:{value:deprecate.deprecateMethod(void 0,function(e,t,i,r,n){return this.init(e,t,i,r,n)},"initWithObject","init")},initWithObjectAndRequire:{value:deprecate.deprecateMethod(void 0,function(e,t,i){return this.init(e,t,i)},"initWithObjectAndRequire","init")}},{getModuleRequire:{value:function(e,t){for(var i=e.resolve(t),r=e.getModuleDescriptor(i);r.redirect||r.mappingRedirect;)r.redirect?i=r.redirect:(e=r.mappingRequire,i=r.mappingRedirect),r=e.getModuleDescriptor(i);return r.require}},_cache:{value:null},moduleContexts:{get:function(){return this._cache||(this._cache=new Map),this._cache}}});MontageDeserializer.defineDeserializationUnit=function(e,t){MontageReviver.defineUnitReviver(e,t)},exports.deserialize=function(e,t){return(new MontageDeserializer).init(e,t).deserializeObject()};