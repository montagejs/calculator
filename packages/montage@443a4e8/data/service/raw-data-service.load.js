montageDefine("443a4e8","data/service/raw-data-service",{dependencies:["data/service/data-service","data/service/data-mapping","data/model/data-identifier","core/serialization/deserializer/montage-deserializer","collections/map","montage","collections/weak-map","core/deprecate"],factory:function(e,t,a){var i=e("data/service/data-service").DataService,r=e("data/service/data-mapping").DataMapping,n=e("data/model/data-identifier").DataIdentifier,o=e("core/serialization/deserializer/montage-deserializer").MontageDeserializer,s=e("collections/map"),c=e("montage").Montage,u=e("collections/weak-map"),p=e("core/deprecate");t.RawDataService=i.specialize({constructor:{value:function(){i.call(this),this._typeIdentifierMap=new s}},initWithModel:{value:function(t){var a=this;return e.async(t).then(function(t){var a=(new o).init(JSON.stringify(t),e);return a.deserializeObject()}).then(function(e){return a.model=e,a})}},deserializeSelf:{value:function(e){this["super"](e)}},connectionDescriptor:{value:void 0},connection:{value:void 0},_propertyDescriptorForObjectAndName:{value:function(e,t){var a=this.objectDescriptorForObject(e);return a&&a.propertyDescriptorForName(t)}},_objectDescriptorForObject:{value:function(e){var t,a,i,r,n,o=this.types,s=c.getInfoForObject(e),u=s.moduleId,p=s.objectName;for(r=0,n=o.length;r<n&&!i;r+=1)t=o[r].module,a=t&&o[r].exportName,t&&u===t.id&&p===a&&(i=o[r]);return i}},_mapObjectPropertyValue:{value:function(e,t,a){var i=t.name;if(t.cardinality===1/0?this.spliceWithArray(e[i],a):e[i]=a[0],t.inversePropertyName&&a&&a[0]){var r=this._propertyDescriptorForObjectAndName(a[0],t.inversePropertyName);r&&1===r.cardinality&&a.forEach(function(a){a[t.inversePropertyName]=e})}return a}},_objectDescriptorTypeForValueDescriptor:{value:function(e){return e.then(function(e){return e.module.require.async(e.module.id)})}},_fetchRawData:{value:function(e){var t=this,a=this._childServiceForQuery(e.query),r=e.query;a?a._fetchRawData(e):r.authorization?(e.query=t.mapSelectorToRawDataQuery(r),t.fetchRawData(e),e.query=r):this.authorizationPolicy===i.AuthorizationPolicy.NONE?(e.query=t.mapSelectorToRawDataQuery(r),t.fetchRawData(e),e.query=r):i.authorizationManager.authorizeService(this).then(function(e){return t.authorization=e,e})["catch"](function(e){console.log(e)}).then(function(a){e.query=t.mapSelectorToRawDataQuery(r),t.fetchRawData(e),e.query=r})}},fetchRawData:{value:function(e){this.rawDataDone(e)}},cancelRawDataStream:{value:function(e,t){}},deleteDataObject:{value:function(e){var t={};return this._mapObjectToRawData(e,t),this.deleteRawData(t,e)}},deleteRawData:{value:function(e,t){return this.nullPromise}},saveRawData:{value:function(e,t){return this.nullPromise}},isOffline:{get:function(){return this===this.rootService?this.superForGet("isOffline")():this.rootService.isOffline}},writeOfflineData:{value:function(e,t,a){return this.nullPromise}},addRawData:{value:function(e,t,a){var i,r,n,o,s=e.query.type;for(i=t&&!this.isOffline&&this._streamRawData.get(e),i?i.push.apply(i,t):t&&!this.isOffline&&this._streamRawData.set(e,t.slice()),r=0,n=t&&t.length;r<n;r+=1)o=t[r],this.addOneRawData(e,o,a,s).then(function(t){e.addData([t])})}},addOneRawData:{value:function(e,t,a){var i,r=this.objectForTypeRawData(e.query.type,t,a);return i=this._mapRawDataToObject(t,r,a),i=i&&i instanceof Promise?i.then(function(){return r}):Promise.resolve(r),this._addMapDataPromiseForStream(i,e),r&&this.callDelegateMethod("rawDataServiceDidAddOneRawData",this,e,t,r),i}},_addMapDataPromiseForStream:{value:function(e,t){this._streamMapDataPromises.has(t)?this._streamMapDataPromises.get(t).push(e):this._streamMapDataPromises.set(t,[e])}},_streamMapDataPromises:{get:function(){return this.__streamMapDataPromises||(this.__streamMapDataPromises=new s),this.__streamMapDataPromises}},objectForTypeRawData:{value:function(e,t,a){var i=this.dataIdentifierForTypeRawData(e,t);return this.recordSnapshot(i,t),this.getDataObject(e,t,a,i)}},_typeIdentifierMap:{value:void 0},dataIdentifierForTypeRawData:{value:function(e,t){var a,i,r,o,c=this.mappingWithType(e),u=c?c.rawDataPrimaryKeys:null;if(u&&u.length){r=this._typeIdentifierMap.get(e),r||this._typeIdentifierMap.set(e,r=new s);for(var p,l=0;p=u[l];l++)a=a||[],a[l]=t[p];if(a&&(o=a.join("/"),i=r.get(o)),!i){e.typeName||e.name;i=new n,i.objectDescriptor=e,i.dataService=this,i.typeName=e.name,i._identifier=i.primaryKey=o,r.set(o,i)}return i}}},__snapshot:{value:null},_snapshot:{get:function(){return this.__snapshot||(this.__snapshot=new s)}},recordSnapshot:{value:function(e,t){this._snapshot.set(e,t)}},removeSnapshot:{value:function(e){this._snapshot["delete"](e)}},snapshotForDataIdentifier:{value:function(e){return this._snapshot.get(e)}},snapshotForObject:{value:function(e){return this.snapshotForDataIdentifier(this.dataIdentifierForObject(e))}},rawDataDone:{value:function(e,t){var a=this,i=this._streamRawData.get(e),r=this._streamMapDataPromises.get(e),n=r?Promise.all(r):this.nullPromise;r&&this._streamMapDataPromises["delete"](e),i&&this._streamRawData["delete"](e),n.then(function(r){return i?a.writeOfflineData(i,e.query,t):null}).then(function(){return e.dataDone(),null})["catch"](function(e){console.error(e)})}},_streamRawData:{get:function(){return this.__streamRawData||(this.__streamRawData=new u),this.__streamRawData}},__streamRawData:{value:void 0},mapSelectorToRawDataQuery:{value:function(e){return e}},mapSelectorToRawDataSelector:{value:p.deprecateMethod(void 0,function(e){return this.mapSelectorToRawDataQuery(e)},"mapSelectorToRawDataSelector","mapSelectorToRawDataQuery")},mappingForObject:{value:function(e){var t=this.objectDescriptorForObject(e),a=t&&this.mappingWithType(t);return!a&&t&&(a=this._objectDescriptorMappings.get(t),a||(a=r.withObjectDescriptor(t),this._objectDescriptorMappings.set(t,a))),a}},mapRawDataToObject:{value:function(e,t,a){}},_mapRawDataToObject:{value:function(e,t,a){var i,r=this,n=this.mappingForObject(t);return n?(i=n.mapRawDataToObject(e,t,a),i=i?i.then(function(){return r.mapRawDataToObject(e,t,a)}):this.mapRawDataToObject(e,t,a)):i=this.mapRawDataToObject(e,t,a),i}},mapObjectToRawData:{value:function(e,t,a){}},_mapObjectToRawData:{value:function(e,t,a){var i,r=this.mappingForObject(e);if(r&&(i=r.mapObjectToRawData(e,t,a)),t)if(i){var n=this.mapObjectToRawData(e,t,a);i instanceof Promise&&n instanceof Promise?i=Promise.all([i,n]):n instanceof Promise&&(i=n)}else i=this.mapObjectToRawData(e,t,a);return i}},_mappingsPromise:{get:function(){return this.__mappingsPromise||(this.__mappingsPromise=Promise.all(this.mappings.map(function(e){return e.objectDescriptor})).then(function(e){})),this.__mappingsPromise}},_objectDescriptorMappings:{get:function(){return this.__objectDescriptorMappings||(this.__objectDescriptorMappings=new s),this.__objectDescriptorMappings}},mapFromRawData:{value:function(e,t,a){}},mapToRawData:{value:function(e,t){}},offlineService:{value:void 0}})}});